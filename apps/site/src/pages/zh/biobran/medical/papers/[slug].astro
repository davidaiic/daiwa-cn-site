---
import BaseLayout from '../../../../../layouts/BaseLayout.astro';
import Header from '../../../../../components/Header.astro';
import Footer from '../../../../../components/Footer.astro';
import { loadPapers } from '../../../../../lib/papers';
import Comments from '../../../../../components/Comments.astro';  // ← 新增

export async function getStaticPaths() {
  const list = loadPapers();
  return list.map(p => ({ params: { slug: p.slug }, props: { paper: p } }));
}
const { paper } = Astro.props;
const title = paper?.title || 'Paper';
const desc = `${(paper?.authors||[]).join(', ')} · ${paper?.journal||''} · ${paper?.year||''}`;
const canonical = new URL(import.meta.env.BASE_URL + `zh/biobran/medical/papers/${paper.slug}/`, Astro.site || 'http://localhost').toString();

// 计算评论用的文章ID（用“最终页面路径”作主键）
const articleId = new URL(
  (import.meta.env.BASE_URL || '/') + `zh/biobran/medical/papers/${paper.slug}/`,
  Astro.site || 'http://localhost'
).pathname;

const jsonld = {
  "@context": "https://schema.org",
  "@type": "ScholarlyArticle",
  "headline": paper.title,
  "author": (paper.authors||[]).map(a => ({ "@type":"Person", name:a })),
  "datePublished": paper.year ? `${paper.year}-01-01` : undefined,
  "isPartOf": paper.journal ? { "@type":"Periodical", name: paper.journal } : undefined,
  "sameAs": paper.url || undefined
};
---
<BaseLayout title={title} description={desc} lang="zh">
  <Fragment slot="header"><Header /></Fragment>

  <article class="mx-auto max-w-3xl px-4 py-10">
    <h1 class="text-3xl md:text-5xl font-semibold">{paper.title}</h1>
    <p class="mt-3 text-neutral-600">{(paper.authors||[]).join(', ')} · {paper.journal} · {paper.year}</p>

    {paper.abstract && <div class="mt-6 p-4 border rounded bg-white shadow-card">
      <h2 class="text-xl font-semibold">摘要</h2>
      <p class="mt-2">{paper.abstract}</p>
    </div>}

    <div class="mt-6 grid gap-2 text-sm">
      {paper.study_type && <div><b>研究类型：</b>{paper.study_type}</div>}
      {paper.population && <div><b>受试人群：</b>{paper.population}</div>}
      {(paper.outcomes||[]).length ? <div><b>主要结局：</b>{paper.outcomes.join('；')}</div> : null}
      {(paper.keywords||[]).length ? <div><b>关键词：</b>{paper.keywords.join('，')}</div> : null}
      {paper.doi || paper.url ? <div><b>外部链接：</b>
        {paper.doi && <a class="text-brand underline" href={`https://doi.org/${paper.doi}`} target="_blank" rel="nofollow">DOI</a>}
        {paper.url && <a class="text-brand underline ml-3" href={paper.url} target="_blank" rel="nofollow">来源</a>}
      </div> : null}
    </div>

    <!-- 评论区（懒加载按钮触发） -->
    <!-- 关键：把当前页面路径传给评论组件 -->
    <Comments articleId={Astro.url.pathname} />

  <Fragment slot="footer"><Footer /></Fragment>
</BaseLayout>
