---
const { articleId } = Astro.props;
---
<section id="comments-root" data-article-id={articleId} class="mt-10">
  <h2 class="text-xl font-semibold">评论</h2>
  <div id="comments"></div>
  <button id="loadComments" class="mt-3 px-4 py-2 rounded bg-brand text-white">加载评论</button>
</section>

<script is:inline>
  (function () {
    const root = document.getElementById('comments-root');
    const mount = document.getElementById('comments');
    const loadBtn = document.getElementById('loadComments');

    // 关键兜底：优先取组件传入的 data-article-id，否则退回浏览器当前路径
    const articleId = (root?.dataset?.articleId && root.dataset.articleId.trim())
      ? root.dataset.articleId
      : (typeof location !== 'undefined' ? location.pathname : '');

    // 优先读取函数域名（.env 里 PUBLIC_TCB_API_BASE），否则回退同域
    const meta = document.querySelector('meta[name="tcb-api-base"]');
    const apiBase =
      (meta && meta.content ? meta.content.replace(/\/+$/, '') : location.origin) +
      (document.baseURI.includes('/daiwa-cn-site/') ? '/daiwa-cn-site' : '');

    const listApi = `${apiBase}/api/comment-list`;
    const postApi = `${apiBase}/api/comment-post`;

    function esc(s){return String(s).replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]))}

    async function load() {
      loadBtn.disabled = true;
      try {
        const res = await fetch(`${listApi}?articleId=${encodeURIComponent(articleId)}`);
        const json = await res.json();
        const items = Array.isArray(json.data) ? json.data : [];
        mount.innerHTML = `
          <div class="space-y-3">
            ${items.map(it => `
              <div class="p-3 border rounded">
                <div class="text-sm text-neutral-600">${new Date(it.createdAt).toLocaleString()}</div>
                <div class="mt-1">${esc(it.content||'')}</div>
              </div>`).join('')}
          </div>
          <form id="cform" class="mt-4 space-y-2">
            <textarea name="content" required placeholder="写下你的看法（审核后可见）" class="w-full border p-2 rounded"></textarea>
            <input name="author" placeholder="称呼（可选）" class="border p-2 rounded" />
            <button class="px-4 py-2 rounded bg-brand text-white">提交</button>
          </form>`;
        const form = document.getElementById('cform');
        form?.addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(form);
          const payload = {
            articleId,
            author: fd.get('author') || '',
            content: fd.get('content') || ''
          };
          const r = await fetch(postApi, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          const jr = await r.json();
          alert(jr.ok ? '已提交，待审核' : ('提交失败：' + (jr.msg || '')));
        });
      } catch (err) {
        console.error(err);
        alert('加载评论失败，请稍后再试');
      } finally {
        loadBtn.disabled = false;
      }
    }

    loadBtn?.addEventListener('click', load);
  })();
</script>
