name: deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-24.04

    env:
      PUBLIC_BASE: /
      PUBLIC_CANONICAL_HOST: https://www.daiwa-pharm.com.cn
      PUBLIC_TCB_API_BASE: ${{ secrets.PUBLIC_TCB_API_BASE }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/site/package-lock.json

      - name: Install deps (apps/site)
        working-directory: apps/site
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi

      - name: Build (apps/site)
        working-directory: apps/site
        run: npm run build

      - name: Install CloudBase CLI
        run: npm install -g @cloudbase/cli --no-audit --no-fund --loglevel=error

      - name: Login
        env:
          TCB_SECRET_ID: ${{ secrets.TCB_SECRET_ID }}
          TCB_SECRET_KEY: ${{ secrets.TCB_SECRET_KEY }}
        run: tcb login --apiKeyId "$TCB_SECRET_ID" --apiKey "$TCB_SECRET_KEY"

      - name: Deploy hosting
        env:
          TCB_ENV_ID: ${{ secrets.TCB_ENV_ID }}
        run: |
          # 不同版本 CLI 命令可能是 hosting:deploy / hosting deploy
          # 先尝试 hosting:deploy，失败再退回 hosting deploy
          tcb hosting:deploy apps/site/dist -e "$TCB_ENV_ID" || \
          tcb hosting deploy apps/site/dist -e "$TCB_ENV_ID"
