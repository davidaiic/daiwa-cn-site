name: deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-24.04
    env:
      # 让 cloudbaserc.json 里的 {{env.envId}} 能取到值
      envId: ${{ secrets.ENVID }}

      # 登录用（你仓库里现有的 secrets）
      TCB_SECRET_ID: ${{ secrets.SECRETID }}
      TCB_SECRET_KEY: ${{ secrets.SECRETKEY }}

      # 推荐加上，避免 CLI 进入交互模式
      CI: "true"

      # 你项目 build 里用到的变量（按你现状保留）
      PUBLIC_BASE: /
      PUBLIC_CANONICAL_HOST: ${{ vars.PUBLIC_CANONICAL_HOST }}
      PUBLIC_TCB_API_BASE: ${{ vars.PUBLIC_TCB_API_BASE }}
      PUSH_TO_SEARCH: ${{ vars.PUSH_TO_SEARCH }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install CloudBase CLI
        run: npm i -g @cloudbase/cli --no-audit --no-fund

      - name: Login (non-interactive)
        run: tcb login --apiKeyId "$TCB_SECRET_ID" --apiKey "$TCB_SECRET_KEY"

      - name: Deploy (hosting + functions) via framework
        run: tcb framework deploy --verbose
