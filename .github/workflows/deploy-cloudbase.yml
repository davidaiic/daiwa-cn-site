name: Deploy to CloudBase

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # 把 GitHub Actions 的 Repository variables 注入到构建环境
    env:
      PUBLIC_BASE: /
      PUBLIC_CANONICAL_HOST: ${{ vars.PUBLIC_CANONICAL_HOST }}
      PUBLIC_TCB_API_BASE: ${{ vars.PUBLIC_TCB_API_BASE }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 安装依赖：有 lockfile 就用 npm ci；否则用 npm install
      - name: Install deps (apps/site)
        working-directory: apps/site
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install --no-audit --no-fund
          fi

      # ✅ 关键：先生成 papers 所需的 src/data/*.json（否则 Astro build 会找不到 paper_taxonomy.json）
      - name: Sync papers data
        working-directory: apps/site
        run: |
          node scripts/sync-papers-data.mjs

      - name: Build (Astro)
        working-directory: apps/site
        run: npm run build

      - name: List dist
        run: |
          ls -la apps/site/dist
          echo "------"
          find apps/site/dist -maxdepth 2 -type f | head -n 80

      - name: Deploy to Tencent CloudBase
        uses: TencentCloudBase/cloudbase-action@v2.0.1
        with:
          secretId: ${{ secrets.SECRETID }}
          secretKey: ${{ secrets.SECRETKEY }}
          envId: ${{ secrets.ENVID }}
          command: framework deploy
        env:
          envId: ${{ secrets.ENVID }}
