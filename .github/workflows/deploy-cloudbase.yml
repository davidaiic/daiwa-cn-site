name: deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    # 关键：使用腾讯云官方 CI runner 镜像（内置 framework + 所有官方插件）
    container:
      image: tencentcloudbase/cloudbase-framework-runner:latest

    env:
      CI: true

      # 关键：cloudbaserc.json 里写的是 {{env.envId}}，所以这里必须叫 envId
      envId: ${{ secrets.ENVID }}

      # 你的登录密钥
      TCB_SECRET_ID: ${{ secrets.SECRETID }}
      TCB_SECRET_KEY: ${{ secrets.SECRETKEY }}

      # 你站点构建用到的环境变量（沿用你现有的）
      PUBLIC_BASE: /
      PUBLIC_CANONICAL_HOST: ${{ vars.PUBLIC_CANONICAL_HOST }}
      PUBLIC_TCB_API_BASE: ${{ vars.PUBLIC_TCB_API_BASE }}
      PUSH_TO_SEARCH: "false"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 镜像里一般已经有 node/npm，但加这一步可以打印版本，便于排查
      - name: Show versions
        shell: bash
        run: |
          node -v
          npm -v
          cloudbase -v || true

      - name: Login (non-interactive)
        shell: bash
        run: |
          set -e
          # 兼容 cloudbase / tcb 两种命令名（不同版本会有别名）
          if command -v tcb >/dev/null 2>&1; then
            tcb login --apiKeyId "$TCB_SECRET_ID" --apiKey "$TCB_SECRET_KEY"
          else
            cloudbase login --apiKeyId "$TCB_SECRET_ID" --apiKey "$TCB_SECRET_KEY"
          fi

      - name: Fix DNS in container (workaround for EAI_AGAIN)
        shell: bash
        run: |
          set -e
          echo "[dns] before:"
          cat /etc/resolv.conf || true
          # 覆盖为公共 DNS（容器内通常可写）
          printf "nameserver 1.1.1.1\nnameserver 8.8.8.8\n" > /etc/resolv.conf
          echo "[dns] after:"
          cat /etc/resolv.conf || true

      - name: Deploy by CloudBase Framework (verbose, retry)
        shell: bash
        run: |
          set -e
          export NODE_OPTIONS="--dns-result-order=ipv4first"

          cmd="tcb framework deploy --verbose"
          if ! command -v tcb >/dev/null 2>&1; then
            cmd="cloudbase framework deploy --verbose"
          fi

          echo "[deploy] cmd: $cmd"

          rc=0
          for i in 1 2 3 4 5; do
            echo "[deploy] attempt $i/5"
            if eval "$cmd"; then
              echo "[deploy] success"
              exit 0
            fi
            rc=$?
            wait=$((i*10))
            echo "[deploy] failed (rc=$rc), retry in ${wait}s..."
            sleep "$wait"
          done

          echo "[deploy] failed after retries (rc=$rc)"
          exit "$rc"

